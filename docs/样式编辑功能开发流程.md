# 样式编辑功能开发流程提示词

## 核心架构设计
**三层架构模式**：主操作栏(ElementPanel) → 编辑面板(StyleEditorPanel) → 样式处理器(TailwindManager)

## 完整开发流程

### 1. 字段配置定义
在 `ElementPanel.buildItems()` 的 schema 中定义字段：
```javascript
{
  type: 'field',
  id: 'padding',
  icon: 'shrink',
  label: '内边距',
  editable: 'panel',
  panelType: 'box-model'
}
```

### 2. 显示逻辑实现
- **值收集**: `collectValues()` 方法从计算样式中提取当前值
- **格式化**: `toBoxValues()` 将像素值格式化为显示文本
- **界面更新**: `updateValues()` 更新操作栏中的显示节点

### 3. 交互事件绑定
```javascript
// 在 bindFieldEvents() 中统一处理点击事件
this.toolbar.addEventListener('click', (event) => {
  const field = event.target.closest('.wve-toolbar-item[data-type="field"]');
  if (field) this.handleFieldClick(field);
});
```

### 4. 面板触发机制
- **元数据查找**: `getFieldMeta()` 获取字段配置信息
- **面板打开**: `openStylePanel()` 调用 StyleEditorPanel 的 open 方法
- **定位逻辑**: 智能计算面板位置，避免超出视口边界

### 5. 编辑面板实现
```javascript
// 创建专用编辑器
createBoxModelEditor() {
  // 获取当前值: getCurrentBoxModelValues()
  // 创建输入控件: 四个方向的数值输入框
  // 绑定实时更新: input.addEventListener('input', ...)
}
```

### 6. 样式应用策略
- **优先 Tailwind**: 使用 TailwindManager 转换 CSS 为 Tailwind 类
- **降级内联**: 转换失败时回退到内联样式
- **通信机制**: 通过 sendInlineStyleOperation 同步到编辑器

### 7. 状态管理
- **刷新控制**: suppressRefresh 标志防止编辑时的重复更新
- **事件通信**: wveStyleChange 事件通知其他组件样式变更

## 关键技术要点

### 样式值处理
```javascript
// 统一的样式值提取和格式化
toBoxValues(style, name) {
  const parts = ['Top', 'Right', 'Bottom', 'Left'].map(side => {
    const raw = style.getPropertyValue(`${name}-${side.toLowerCase()}`);
    return Math.round(parseFloat(raw)) || 0;
  });

  const allEqual = parts.every(v => v === parts[0]);
  return allEqual
    ? { text: `${parts[0]}px` }
    : { text: parts.map(v => `${v}px`).join(' ') };
}
```

### 面板定位算法
```javascript
// 智能定位避免溢出
positionPanel(triggerElement) {
  const rect = triggerElement.getBoundingClientRect();
  let { left, top } = this.calculateOptimalPosition(rect);

  // 边界检查和调整
  left = Math.max(margin, Math.min(left, viewportWidth - panelWidth - margin));
  top = rect.bottom + margin > viewportHeight - panelHeight
    ? rect.top - panelHeight - margin
    : rect.bottom + margin;
}
```

### 双向数据绑定
```javascript
// 实时样式应用
input.addEventListener('input', () => {
  this.applyBoxModelChange(direction.key, input.value);
});

async applyBoxModelChange(direction, value) {
  const cssStyles = {};
  cssStyles[`${this.currentField}${capitalize(direction)}`] = `${value}px`;

  try {
    await this.tailwindManager.saveStyleChanges(element, cssStyles);
  } catch (error) {
    // 降级到内联样式
    this.fallbackToInlineStyle(cssStyles);
  }
}
```

## 扩展模板

基于这套流程，实现新功能只需要：

1. **添加字段配置** - 在 schema 中定义新字段
2. **实现值收集器** - 添加对应的 `to[FieldName]` 方法
3. **创建编辑器** - 在 StyleEditorPanel 中添加 `create[Type]Editor` 方法
4. **定义应用逻辑** - 实现 `apply[Type]Change` 方法

## 开发检查清单

### ElementPanel 修改
- [ ] 在 schema 中添加字段定义
- [ ] 在 `getFieldMeta()` 中添加字段元数据
- [ ] 实现对应的 `to[FieldName]()` 值格式化方法
- [ ] 在 `collectValues()` 中添加值收集逻辑

### StyleEditorPanel 修改
- [ ] 添加 `create[Type]Editor()` 方法
- [ ] 实现 `getCurrent[Type]Values()` 值获取方法
- [ ] 添加 `apply[Type]Change()` 应用逻辑
- [ ] 在 `createContent()` 的 switch 中添加 case

### 样式处理集成
- [ ] 确保 TailwindManager 支持对应的 CSS 属性
- [ ] 处理转换失败的降级逻辑
- [ ] 测试 Tailwind 类名生成和内联样式回退

### 交互体验
- [ ] 面板定位合理，避免溢出视口
- [ ] 输入控件响应及时，无明显延迟
- [ ] 关闭逻辑正确，支持外部点击关闭
- [ ] 状态同步准确，防止重复刷新

这套流程确保了代码的一致性、可维护性和扩展性，新功能可以快速复用现有的基础设施。